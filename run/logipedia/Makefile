# Generic Makefile to run Coqine

# Variables
COQ_MAKEFILE ?= coq_makefile
COQC         ?= coqc
DKCHECK      ?= dkcheck
DKDEP        ?= dkdep
VERBOSE      ?=
MAINFILE     ?= main

OUTFOLDER = out
COQINEPATH=../../src

DKS = $(wildcard $(OUTFOLDER)/*.dk)
DKOS = $(DKS:.dk=.dko)

define MAIN_BODY=
Declare ML Module "coqine_plugin".
Dedukti Set Destination "$(OUTFOLDER)".
Dedukti Set Param "simpl_letins" "true".
Require Import import.
Load config.
Dedukti Export All.
endef
export MAIN_BODY

.PHONY: all	compile generate depend check clean

.SUFFIXES: .dk .dko

# Because the [.dk] files are generated by make, the dependencies cannot be
#	precalculated, so we need to call make twice.
all: compile generate depend
	make check  # Call make again so that it include the updated depend file
	rm CoqMakefile

main.v:
	@echo "$$MAIN_BODY" > main.v

# Compile the local [.v] files that are not part of the stdlib
compile: main.v $(OUTFOLDER) CoqMakefile
	make -f CoqMakefile

$(OUTFOLDER):
	mkdir $(OUTFOLDER)

# Generate the [.dk] files by executing [main_???.v]
generate: compile $(OUTFOLDER)
	$(COQC) -nois -init-file ../../.coqrc -verbose -R . Top $(MAINFILE).v

# Generate the dependencies of [.dk] files
depend:
	$(DKDEP) -I $(OUTFOLDER) $(OUTFOLDER)/*.dk > .depend

# Check and compile the generated [.dk]
check: $(DKOS)

%.dko: %.dk depend
	$(DKCHECK) -I $(OUTFOLDER) --eta --snf -e $<

clean: CoqMakefile
	make -f CoqMakefile - clean
	rm -rf $(OUTFOLDER) .depend .*.aux *.vo *.dko *.conf *.glob *~
	rm -f CoqMakefile
	rm -f debug.out
	rm -f main.v

CoqMakefile: Make
	$(COQ_MAKEFILE) -f Make -o CoqMakefile

-include .depend
